# mdx2midi

X68000のMDXフォーマットをMIDIに変換するプログラムを作成します。MDXは、X68000向けのサウンドフォーマットで、MIDIに変換することで他のプラットフォームでも再生可能になります。

このプログラムは、X68000のMDXフォーマットの音楽ファイルをMIDIフォーマットに変換するPythonスクリプトです。プログラムの主な機能は以下の通りです：

1. MDXファイルのヘッダー情報を解析し、曲名やトラック数を取得
2. 各トラックのデータを解析し、ノート、休符、テンポ、音量、音色などのイベントをMIDIイベントに変換
3. 変換したデータをMIDIファイルとして保存
4. ループ処理の完全実装（ループ回数の制限設定可能）
5. より多くのMDXコマンドのサポート（デチューン、パンポット、ゲートタイム、LFOなど）
6. 堅牢なエラー処理とファイル検証

## 使用方法

```
python mdx_to_midi.py 入力MDXファイル [-o 出力MIDIファイル] [-l ループ回数] [-v]
```

### オプション

- `-o, --output`: 出力MIDIファイル名（デフォルトは入力ファイル名.mid）
- `-l, --loops`: ループの最大繰り返し回数（0=ループなし、デフォルト=2）
- `-v, --verbose`: 詳細なログ出力を有効にする

## 対応コマンド

以下のMDXコマンドに対応しています：

- ノートオン (0x80-0xDF)
- 休符 (0x00)
- テンポ設定 (0xE7)
- 音量設定 (0xEB)
- 音色設定 (0xE6)
- ループ開始/終了 (0xE1/0xE2)
- デチューン (0xEA)
- パンポット設定 (0xEC)
- ゲートタイム (0xE9)
- LFO設定（基本的なパラメータのみ）(0xE3)
- OPMレジスタ設定（一部のみ）(0xED)

## テスト

ユニットテストを実行するには：

```
python test_mdx_to_midi.py
```

## 注意点

このプログラムは基本的なMDXからMIDIへの変換機能を実装していますが、X68000のMDXフォーマットには複雑な機能（エンベロープ、LFO、FMシンセシス固有のパラメータなど）が多くあり、完全な変換は難しい場合があります。特にOPM（YM2151）の音色パラメータはMIDIに完全に対応するものがないため、近似的な変換を行っています。

## 依存パッケージ

このプログラムを実行するには、Python環境と`midiutil`パッケージのインストールが必要です：
```
pip install midiutil
```

## エラー処理

以下のエラーを検出して適切に処理します：

- ファイルが見つからない
- MDXフォーマットが無効
- トラックデータが不完全
- 無効なポインタ値
- バッファ境界外のアクセス
